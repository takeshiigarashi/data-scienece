<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js">
</script>
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({
 tex2jax: {
 inlineMath: [['$', '$'] ],
 displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
 }
 });
</script>

# 8.12 統計的仮説検定

## 帰無仮説と対立仮説

- **帰無仮説** $H_0$ : ２つの集団の間に差はないと主張する仮説
- **対立仮説** $H_1$ : ２つの集団の間に差があると主張する仮説

例: ２つのデータ群の平均値に差があるかどうかを知りたい場合、以下のよう仮説を立てることができる。

- 帰無仮説 $H_0$ ２つのデータ群の平均値に差がない
- 対立仮説 $H_1$ ２つのデータ群の平均値に差がある

### ポテトチップスの例

- 内容量 150g と記載されたポテトチップスを10袋購入した
- 想定結果は 147, 143, 142, 145, 140, 150, 149, 142, 143, 143 (g)
- 平均は 144.4g 1だった
- これは、**ありえないことが起こっているのか？**

統計的仮説検定の仮説は以下のように立てる

- 帰無仮説 $H_0$ : ポテトチップスの内容量の平均は 150g である
- 対立仮説 $H_1$ : ポテトチップスの内容量の平均は 150g ではない

※仮説検定は、「どの程度をありえないことと捉えるのかを決め」、「仮説が正しいと仮定したときに、ありえないことが起こっているのであれば、仮説は間違っていた」と考える。

## 言葉の定義

- **有意水準**とは、仮説を棄却してよいかどうかを判断する基準となる確率。5%と設定した場合、5%以下の確率で生じる事象は「ありえないこと」とみなす。
- **検定統計量**とは、標本データから計算される数量で、仮説を検証するための指標として使う。
- **棄却域**とは、帰無仮説を棄却する判断となるために検定統計量がとるべき値の範囲
- **採択域**または**受容域**とは、棄却域以外の領域

## 有意水準を決める

**有意水準**は、帰無仮説が妥当ではないと判断する基準となる確率値。1%や5%などにすることが多い。

有意水準を5%に設定するということは、「帰無仮説が正しいという前提のもとで、5%以下の確率でしか起こり得ないことが起こったとしたら、帰無仮説は妥当ではないと判断し、帰無仮説を棄却する」、ということを意味する。

## Z検定

**Z検定**は、母集団が正規分布に従うか、サンプルサイズが十分大きい場合（中心極限定理が適用できる場合）に適用される。

Z検定で計算する**Z統計量**には、<u>母集団の平均と標準偏差が必要となるため、これらが既知である必要がある</u>。母集団の平均は与えられることが多い（ボテとチップスの例）が、標準偏差については未知であることが多い。母集団の標準偏差が不明なときは、後ほど説明する**t統計量**と**t検定**を用いる。

以下では母平均に対する検定として手順などを記載する。

仮説の設定
- 帰無仮説 $H_0$ : 母平均が特定の値に等しい
- 対立仮説 $H_1$ : 母平均が特定の値と異なる

検定統計量 $Z$ を以下で計算する。

$$Z = \frac{\bar{x} - \mu}{\sigma / \sqrt{n}}$$

ここで、 $\bar{x}$ は標本平均、 $\mu$ は仮説の母平均、 $\sigma$ は母集団の標準偏差、 $n$ は標本サイズ。

標準正規分布 $Z$ は、 $\pm1.96\sigma$ に95%のデータが集まっているが、これはつまり、以下とも言える。

$$P(Z \ge 1.96\sigma) = P(Z \le -1.96\sigma) = 0.025$$

ここで、標準正規分布は $\sigma=1$ である。つまり、Z値が1.96以上または-1.96以下となる確率は5%となる。

これは、有意水準を5%とすると、Z値が-1.96以下、または、1.96以上であるなら、帰無仮説は棄却される、という意味となる。


### ポテトチップスの例

ポテトチップスの例に戻ってZ検定を適用してみる。

再掲となるが、状況は以下である。

- 内容量 150g と記載されたポテトチップスを10袋購入した
- 想定結果は 147, 143, 142, 145, 140, 150, 149, 142, 143, 143 (g)
- 平均は 144.4g 1だった
- これは、**ありえないことが起こっているのか？**

統計的仮説検定の仮説は以下のように立てる

- 帰無仮説 $H_0$ : ポテトチップスの内容量の平均は 150g である
- 対立仮説 $H_1$ : ポテトチップスの内容量の平均は 150g ではない

Z検定のためには母集団の標準偏差が必要となる。ここでは $\sigma = 3.9 (g)$ として検定をしてみる。

Z統計量: 

$$Z = \frac{\bar{x} - \mu}{\sigma / \sqrt{n}} = \frac{144.4 - 150}{3.9 / \sqrt{10}} = -4.54$$

有意水準を0.05としたとき、Z検定における棄却域は $Z \le -1.96$ または $Z \ge 1.96$ であるため、 -4.54 は棄却域に入る。（起こる可能性が5%よりも小さい。）

<u>つまり、帰無仮説である「ポテトチップスの内容量の平均は 150g である」は棄却され、「平均は 150g ではない」という対立仮説が採択される</u>。

## 片側検定と両側検定

**両側検定**は、棄却域を確率分布の両側にとる。帰無仮説、対立仮説は以下になる。

- 帰無仮説 $H_0$ : 母数 $\mu$ は、標本平均 $\bar{x}$ と等しい
- 対立仮説 $H_1$ : 母数 $\mu$ は、標本平均 $\bar{x}$ と等しくない

**片側検定**は、棄却域を確率分布の片側にとる。帰無仮説、対立仮説は以下になる。

- 帰無仮説 $H_0$ : 母数 $\mu$ は、標本平均 $\bar{x}$ と等しい
- 対立仮説 $H_1$ : 母数 $\mu$ は、標本平均 $\bar{x}$ より大きい（または小さい）

## t分布に基づいた仮説検定

**t検定**は、**t分布**を用いた仮説検定で、正規分布に従う母集団に対して、母集団の分散（標準偏差）が未知である場合に行う。

### t分布を用いた仮説検定（１標本問題）

ポテトチップスの例のような、１セットの標本で行う検定を「１標本問題」という。

t統計量:

$$t = \frac{\bar{x}-\mu}{\hat{S}/\sqrt{n}}$$

Z統計量と似ているが、Z統計量では母集団の標準偏差 $\sigma$ を使っていたが、t統計量では標本から計算される不偏分散を使う。

不偏分散は以下で得られる。

$$\hat{S}^2 = \frac{1}{n-1}\sum_{i=1}^n (x_i - \bar{x})^2$$

ここで、 $\bar x$ は、標本の平均である（不偏分散は、標本平均を用いて計算する）。

ポテトチップスの例で計算する。

不偏分散を計算すると10.71になる。その平方根は3.27になる。

これを用いてt統計量を計算すると、-5.42になる。

サンプルサイズが10なので、t統計量はは「自由度9のt分布」に従う。t分布表から、自由度9、有意水準0.025を調べると2.262がえられる。つまり、t統計量が-2.262以下、または、2.262以上となる確率は5%である、という意味である。

有意水準を0.05(5%)とした場合、ポテトチップスの例ではt統計量が-5.42となり、-2.262を下回るため、帰無仮説は棄却される（起こり得ないことが起こっている）。

t検定では、サンプルサイズが小さくなるほど自由度が小さくなり、自由度が小さくなるほど棄却域も小さくなる。

### t分布を用いた仮説検定（２標本問題）

２セットの標本で行う検定は「２標本問題」という。

２標本問題は次の２種類がある

- <div>対応のある２標本</div><div>例: ポテトチップスの製造における、「揚げる前の重量」と「揚げた後の重量」</div>
- <div>対応のない２標本</div><div>例: 工場Aでの１パック重量と、工場Bでの１パック重量</div>

<u>対応のある２標本問題では、２つの標本間で差分を取ることで、１標本問題に帰着させることができる</u>。

以下では、対応のない２標本問題について説明する。

以下の状況を考える。

- 母集団１と母集団２はともに、正規分布に従い、その母分散は等しい（同じようなばらつきを持つ集団同士である）
- それぞれの母集団から、サンプル数が $n_1$ 、 $n_2$ である標本を無作為抽出
- 標本から計算された平均は $\bar{x}_1$ 、 $\bar{x}_2$ で、不偏分散は $S_1^2$ 、 $S_2^2$ である。

このとき、帰無仮説と対立仮説は以下になる

- 帰無仮説: 母集団１と母集団２の母平均は等しい ( $\mu_1 = \mu_2$ )
- 対立仮説: 母集団１と母集団２の母平均は等しくない

２標本問題でのt統計量は次式で得られる

$$t = \frac{\bar{x_1} - \bar{x_2}}{\sqrt{\frac{1}{n_1}+\frac{1}{n_2}}\sqrt{\frac{(n_1-1)S_1^2 + (n_2-1)S_2^2}{n1+n2-2}}}$$

このt統計量は、自由度 $n_1 + n_2 - 2$ のt分布に従う。

具体的な例は省略。

（ポテトチップするの例で、２つの工場の平均を考えることができる）

### スチューデントのt検定、ウェルチのt検定

- ２つの母集団の分散が等しいときに用いるt検定を**スチューデントのt検定**という
- ２つの母集団の分散が等しくないときに用いるt検定を**ウェルチのt検定**という
- ２つの母集団の分散が等しいかどうかを検証するため用いられる検定を**F検定**という

## 統計的仮説検定の解釈

統計的仮説検定は、仮説が正しいとか仮説の正しさを証明する、というものではない。

**帰無仮説が棄却された場合**、そのデータは帰無仮説を支持する十分な証拠を持たない、ということを意味している。対立仮説が支持される可能性はあるが、対立仮説が正しいことを示しているわけではない。

「有意な差がある」とは、観測されたデータが偶然によるものと考えるには十分低い確率であり、差が統計的に意味のあるものと結論付けられることを意味する。

**帰無仮説が棄却されなかった場合**、そのデータは帰無仮説を棄却する十分な証拠を持たない、ということを意味している。これもまた、帰無仮説が正しい可能性はあるが、帰無仮説が正しいことを証明しているわけではない。



## 第一種の過誤と第二種の過誤

仮説検定は、あくまでも確率的な判断であるため、誤った判断になっている可能性がある。このようなご判断は２種類に分けられる。

- **第一種の過誤** 帰無仮説を誤って棄却した。普通に起こり得る事象だったのに、特別な事象で起こり得ないと誤った。
- **第二種の過誤** 帰無仮説を誤って棄却しなかった。起こり得ない事象なのに、普通に起こり得ると誤った。

仮説検定では、「帰無仮説は正しい」と仮定して検定を進める。第一種の過誤は、「帰無仮説が正しいのに誤って棄却した」というものである。

混同行列の陽性、陰性と関連付けると、
- 「差がない」は「陰性」を表す
  - 帰無仮説が正しい＝陰性
  - 帰無仮説を棄却しなかった＝陰性
- 「差がある」は「陽性」を表す
  - 帰無仮説が正しくない（対立仮説が正しい）＝陽性
  - 帰無仮説が棄却された（有意な差が認められた）＝陽性

慣習的に、第一種の過誤の確率を $\alpha$ 、第二種の過誤の確率を $\beta$ と書く。

混同行列のように表現できる。

|                         | 帰無仮説を棄却しなかった（陰性）|帰無仮説を棄却した（陽性）
| ------------------------|:--:|:--:
| 帰無仮説は正しい（陰性）    |真陰性( $1-\alpha$ )| <div>第一種の過誤</div>偽陽性( $\alpha$ )
| 帰無仮説は正しくない（陽性） |<div>第二種の過誤</div>偽陰性( $\beta$ )|真陽性( $1-\beta$ )

- 第一種の過誤は、帰無仮説が正しい（差がない＝陰性）のに誤って棄却した（差があると判断した＝陽性）、というもので、混同行列では「偽陽性」に相当する。
- 第二種の過誤は、帰無仮説が正しくない（差がある＝陽性）のに誤って棄却しなかった（差がないと判断した＝陰性）、というもので、「偽陰性」に相当する。
- 適合率、再現率のトレードオフと同様に、第一種の過誤と第二種の過誤もトレードオフの関係になる。
- 第一種の過誤は、有意水準の確率で起こり得る。２つの集団に差がなくても、5%の確率で差があると第一種の過誤を犯してしまう。
- $1-\beta$ を**検定力**という。検定力は、混同行列における真陽性率(TPP)や再現率(Recall)に相当する。
- 検定力が低いと、第二種の過誤が起こりやすい

## P値を用いた仮説検定

**P値**は、**有意確率**といわれ、仮説検定の結果を確率値として表すことができる。

P値は、帰無仮説が正しいと仮定した場合、得られたデータ（検定統計量）が観測される確率を表す。

両側検定であれば、以下の確率となる。

$$P値 = P(T \ge |t|) \times 2$$

これは、累積分布関数 $F$ を用いると、以下になる。

$$P値 = (1 - F(|t|)) \times 2$$

これまでの検定の例では、有意水準から、棄却域となる検定統計量の範囲を求めていた。

P値は、検定統計量が観測される確率であり、有意水準と直接比較することができる。つまり、P値が有意水準より小さければ帰無仮説は棄却される。

## 分散分析、F検定

**分散分析**は、異なるグループやカテゴリ間でのデータのばらつき（分散）を比較し、それらが統計的に有意であるかどうかを判断するための方法。分散分析を用いることで、複数のグループの平均値が同じであるか異なるかを検定することができる。

分散分析の目的は、以下の２点。

- **グループ間の平均の差異を評価する** 異なるグループ（例えば、異なる薬の効果や異なる教育方法の効果）が与える影響が、統計的に有意かどうかを確認する。
- **ばらつきの原因を特定する** 観測されたデータのばらつきが、グループ間の違いによるものか、それともランダムな誤差によるものかを区別する。

分散分析では、全体のばらつき（**総平方和**）を、異なる要因（グループ）によるばらつき（**要因平方和**）と、ランダムな誤差（**誤差平方和**）に分けて評価する。

帰無仮説と対立仮説を次のように立てる

- 帰無仮説 $H_0$ : すべてのグループの平均が等しい
- 対立仮説 $H_1$ : 少なくとも１つのグループの平均が異なる

分散分析では、**F統計量**を使って帰無仮説の検定を行う。

$$F = \frac{\text{ 要因平方和 } / \text{ 自由度 }}{\text{ 誤差平方和 } / \text{ 自由度 }}$$

F値が大きければ、グループ間の平均の際がランダムな誤差によるものではない可能性が高いと考える。

F値を計算した後、F分布にを使って、計算したF値が帰無仮説を棄却するのに十分大きいかどうかを判断する。一般的に、F値が臨界値より大きければ、帰無仮説を棄却する。

分散分析にはいくつか種類がある。

- **一元配置分散分析** (**One-Way ANOVA**):
  - １つの要因（例えば、薬の種類）によってグループを分け、その平均値の際が有意かどうかを検定する。
  - 例えば、異なる教育方法方法（A, B, C）の効果を比較する場合など
- **二元配置分散分析** (**Two-Way ANOVA**):
  - ２つの要因（例えば、薬の種類と投与量）がグループに与える影響を同時に検定する。
  - 交互作用（例えば、薬の種類と投与量が相互に作用して結果に影響を与える場合）も評価する。
- **反復測定分散分析** (**Repeated Measures ANOVA**):
  - 同一の対象に対して複数回の測定が行われ、各測定結果の違いを評価する方法
  - 例えば、同じ患者に対して治療前後で何度も測定を行った場合など

分散分析を行うにはいくつかの前提条件が必要

- **正規性** 各グループのデータが正規分布に従っていること
- **分散の等質性** 各グループのデータの分散が等しいこと
- **独立性** 各サンプルが独立していること


前提条件を満たさない場合、非パラメトリックな手法（クラスカル・ワリス検定など）を使うことがある。

分散分析の結果、**有意な差があった場合**（帰無仮説が棄却される場合）、少なくとも１つのグループの平均が他と異なると判断できる。どのグループがことなるかを特定するためには**事後検定**を行うことがある。例えば**HSD** (**Honestly Significant Difference**)テストなどを使用してどのグループ間で差があるのかを調べる。**有意な差がなかった場合**、すべてのグループの平均は統計的に等しいと判断される。